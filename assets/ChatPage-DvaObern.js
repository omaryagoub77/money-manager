import{a as e,d as t,f as n,i as r,l as i,m as a,n as o,o as s,p as c,r as l,s as u,t as d,u as f,v as p,y as m}from"./index-6XTB6nXq.js";var h=m(p()),g=m(o());function _(){let{currentUser:o}=d(),[p,m]=(0,h.useState)([]),[_,v]=(0,h.useState)(``),[y,b]=(0,h.useState)(!0),[x,S]=(0,h.useState)({}),C=(0,h.useRef)(),w=(0,h.useRef)(null),T=e=>{if(!e)return!1;let t=e.toDate?e.toDate():new Date(e);return new Date-t<6e4};(0,h.useEffect)(()=>{if(!o)return;(async()=>{try{let e=s(l,`users`,o.uid);(await u(e)).exists()?await a(e,{isOnline:!0,lastActive:n()}):await c(e,{isOnline:!0,lastActive:n(),email:o.email,displayName:o.email.split(`@`)[0]})}catch(e){console.error(`Error setting user online:`,e)}})(),w.current=setInterval(async()=>{try{let e=s(l,`users`,o.uid);await a(e,{isOnline:!0,lastActive:n()})}catch(e){console.error(`Error updating presence:`,e)}},3e4);let e=async()=>{try{let e=s(l,`users`,o.uid);await a(e,{isOnline:!1,lastActive:n()})}catch(e){console.error(`Error setting user offline:`,e)}};return window.addEventListener(`beforeunload`,e),()=>{w.current&&clearInterval(w.current),window.removeEventListener(`beforeunload`,e),e()}},[o]),(0,h.useEffect)(()=>{if(!o)return;let n=t(e(l,`messages`),f(`timestamp`,`asc`)),r=i(n,e=>{m(e.docs.map(e=>({id:e.id,...e.data()}))),b(!1)}),a=e(l,`users`),s=i(a,e=>{let t={};e.forEach(e=>{let n=e.data();t[e.id]={isOnline:n.isOnline||!1,lastActive:n.lastActive,displayName:n.displayName||n.email?.split(`@`)[0]||`Unknown`}}),S(t)});return()=>{r(),s()}},[o]);let E=async t=>{if(t.preventDefault(),_.trim())try{await r(e(l,`messages`),{text:_,userId:o.uid,userName:o.email.split(`@`)[0],timestamp:n()}),v(``)}catch(e){console.error(`Error sending message:`,e)}};(0,h.useEffect)(()=>{C.current?.scrollIntoView({behavior:`smooth`})},[p]);let D=e=>e?e.toDate().toLocaleTimeString([],{hour:`2-digit`,minute:`2-digit`}):``;return(0,g.jsxs)(`div`,{className:`chat-container`,children:[(0,g.jsxs)(`div`,{className:`chat-header`,children:[(0,g.jsxs)(`div`,{className:`chat-header-avatar`,children:[o?.email?.charAt(0).toUpperCase()||`U`,(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[o?.uid]?.lastActive)?`online`:`offline`}`,title:T(x[o?.uid]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`chat-header-info`,children:[(0,g.jsx)(`h1`,{children:`Chat Room`}),(0,g.jsxs)(`p`,{children:[p.length,` Messages`]}),(0,g.jsxs)(`p`,{children:[`Online Users: `,(()=>Object.entries(x).filter(([e,t])=>T(t.lastActive)).sort(([e,t],[n,r])=>t.displayName.localeCompare(r.displayName)))().length]})]})]}),(0,g.jsxs)(`div`,{className:`messages-container`,children:[y?(0,g.jsx)(`div`,{className:`loading-indicator`,children:(0,g.jsxs)(`div`,{className:`loading-dots`,children:[(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`})]})}):p.length===0?(0,g.jsxs)(`div`,{className:`empty-state`,children:[(0,g.jsx)(`div`,{className:`empty-state-icon`,children:`ðŸ’¬`}),(0,g.jsx)(`div`,{className:`empty-state-text`,children:`No messages yet. Start a conversation!`})]}):p.map(e=>(0,g.jsxs)(`div`,{className:`message ${e.userId===o.uid?`message-sent`:`message-received`}`,children:[e.userId!==o.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-received`,children:[e.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[e.userId]?.lastActive)?`online`:`offline`}`,title:T(x[e.userId]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`message-bubble ${e.userId===o.uid?`message-bubble-sent`:`message-bubble-received`}`,children:[(0,g.jsx)(`div`,{className:`message-text`,children:e.text}),(0,g.jsx)(`div`,{className:`message-timestamp`,children:D(e.timestamp)})]}),e.userId===o.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-sent`,children:[e.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[e.userId]?.lastActive)?`online`:`offline`}`,title:T(x[e.userId]?.lastActive)?`Online`:`Offline`})]})]},e.id)),(0,g.jsx)(`div`,{ref:C})]}),(0,g.jsxs)(`form`,{onSubmit:E,className:`input-container`,children:[(0,g.jsx)(`div`,{className:`input-wrapper`,children:(0,g.jsx)(`input`,{type:`text`,className:`message-input`,placeholder:`Type a message...`,value:_,onChange:e=>v(e.target.value)})}),(0,g.jsx)(`button`,{type:`submit`,className:`send-button`,disabled:!_.trim(),children:(0,g.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 24 24`,fill:`currentColor`,className:`send-icon`,children:(0,g.jsx)(`path`,{d:`M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z`})})})]})]})}var v=()=>(0,g.jsx)(`div`,{style:{marginTop:`65px`},children:(0,g.jsx)(_,{})});export{v as default};