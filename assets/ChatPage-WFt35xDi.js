import{a as e,b as t,c as n,d as r,f as i,g as a,h as o,i as s,m as c,n as l,o as u,p as d,r as f,s as p,x as m}from"./index-BU7x7Pco.js";var h=m(t()),g=m(f());function _(){let{currentUser:t}=l(),[f,m]=(0,h.useState)([]),[_,v]=(0,h.useState)(``),[y,b]=(0,h.useState)(!0),[x,S]=(0,h.useState)({}),C=(0,h.useRef)(),w=(0,h.useRef)(null),T=e=>{if(!e)return!1;let t=e.toDate?e.toDate():new Date(e);return new Date-t<6e4};(0,h.useEffect)(()=>{if(!t)return;(async()=>{try{let e=p(s,`users`,t.uid);(await n(e)).exists()?await a(e,{isOnline:!0,lastActive:c()}):await o(e,{isOnline:!0,lastActive:c(),email:t.email,displayName:t.email.split(`@`)[0]})}catch(e){console.error(`Error setting user online:`,e)}})(),w.current=setInterval(async()=>{try{let e=p(s,`users`,t.uid);await a(e,{isOnline:!0,lastActive:c()})}catch(e){console.error(`Error updating presence:`,e)}},3e4);let e=async()=>{try{let e=p(s,`users`,t.uid);await a(e,{isOnline:!1,lastActive:c()})}catch(e){console.error(`Error setting user offline:`,e)}};return window.addEventListener(`beforeunload`,e),()=>{w.current&&clearInterval(w.current),window.removeEventListener(`beforeunload`,e),e()}},[t]),(0,h.useEffect)(()=>{if(!t)return;let e=d(u(s,`messages`),i(`timestamp`,`asc`)),n=r(e,e=>{m(e.docs.map(e=>({id:e.id,...e.data()}))),b(!1)}),a=u(s,`users`),o=r(a,e=>{let t={};e.forEach(e=>{let n=e.data();t[e.id]={isOnline:n.isOnline||!1,lastActive:n.lastActive,displayName:n.displayName||n.email?.split(`@`)[0]||`Unknown`}}),S(t)});return()=>{n(),o()}},[t]);let E=async n=>{if(n.preventDefault(),_.trim())try{await e(u(s,`messages`),{text:_,userId:t.uid,userName:t.email.split(`@`)[0],timestamp:c()}),v(``)}catch(e){console.error(`Error sending message:`,e)}};(0,h.useEffect)(()=>{C.current?.scrollIntoView({behavior:`smooth`})},[f]);let D=e=>e?e.toDate().toLocaleTimeString([],{hour:`2-digit`,minute:`2-digit`}):``;return(0,g.jsxs)(`div`,{className:`chat-container`,children:[(0,g.jsxs)(`div`,{className:`chat-header`,children:[(0,g.jsxs)(`div`,{className:`chat-header-avatar`,children:[t?.email?.charAt(0).toUpperCase()||`U`,(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[t?.uid]?.lastActive)?`online`:`offline`}`,title:T(x[t?.uid]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`chat-header-info`,children:[(0,g.jsx)(`h1`,{children:`Chat Room`}),(0,g.jsxs)(`p`,{children:[f.length,` Messages`]}),(0,g.jsxs)(`p`,{children:[`Online Users: `,(()=>Object.entries(x).filter(([e,t])=>T(t.lastActive)).sort(([e,t],[n,r])=>t.displayName.localeCompare(r.displayName)))().length]})]})]}),(0,g.jsxs)(`div`,{className:`messages-container`,children:[y?(0,g.jsx)(`div`,{className:`loading-indicator`,children:(0,g.jsxs)(`div`,{className:`loading-dots`,children:[(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`})]})}):f.length===0?(0,g.jsxs)(`div`,{className:`empty-state`,children:[(0,g.jsx)(`div`,{className:`empty-state-icon`,children:`ðŸ’¬`}),(0,g.jsx)(`div`,{className:`empty-state-text`,children:`No messages yet. Start a conversation!`})]}):f.map(e=>(0,g.jsxs)(`div`,{className:`message ${e.userId===t.uid?`message-sent`:`message-received`}`,children:[e.userId!==t.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-received`,children:[e.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[e.userId]?.lastActive)?`online`:`offline`}`,title:T(x[e.userId]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`message-bubble ${e.userId===t.uid?`message-bubble-sent`:`message-bubble-received`}`,children:[(0,g.jsx)(`div`,{className:`message-text`,children:e.text}),(0,g.jsx)(`div`,{className:`message-timestamp`,children:D(e.timestamp)})]}),e.userId===t.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-sent`,children:[e.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[e.userId]?.lastActive)?`online`:`offline`}`,title:T(x[e.userId]?.lastActive)?`Online`:`Offline`})]})]},e.id)),(0,g.jsx)(`div`,{ref:C})]}),(0,g.jsxs)(`form`,{onSubmit:E,className:`input-container`,children:[(0,g.jsx)(`div`,{className:`input-wrapper`,children:(0,g.jsx)(`input`,{type:`text`,className:`message-input`,placeholder:`Type a message...`,value:_,onChange:e=>v(e.target.value)})}),(0,g.jsx)(`button`,{type:`submit`,className:`send-button`,disabled:!_.trim(),children:(0,g.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 24 24`,fill:`currentColor`,className:`send-icon`,children:(0,g.jsx)(`path`,{d:`M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z`})})})]})]})}var v=()=>(0,g.jsx)(`div`,{style:{marginTop:`20px`},children:(0,g.jsx)(_,{})});export{v as default};